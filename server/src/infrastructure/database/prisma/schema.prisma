generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// ---------- Enums ----------
enum US_ROLE {
  ADMIN
  HOD
  HOS
  TECHNICAL
  STAFF
  EMPLOYEE
}

enum DEVICE_CHILD_STATUS {
  READY
  BORROWED
  REPAIRING
  DAMAGED
  LOST
}

enum BRT_STATUS {
  PENDING
  APPROVED
  IN_USE
  OVERDUE
  COMPLETED
  REJECTED
}

enum BRTS_STATUS {
  PENDING
  APPROVED
  REJECTED
}

enum TI_STATUS {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum TI_RESULT {
  SUCCESS
  FAILED
  IN_PROGRESS
}

enum DA_STATUS {
  ACTIVE
  COMPLETED
}

enum BASE_EVENT {
  DEVICE_CREATED
  APPROVAL_REQUESTED
  NOTIFICATION_FULFILLED
  NOTIFICATION_RESOLVED
  TICKET_CREATED
  TICKET_APPROVED
  TICKET_REJECTED
  TICKET_STAGE_PASSED
  TICKET_RETURNED
  TICKET_DUE_SOON
  TICKET_OVERDUE
  ISSUE_REPORTED
  ISSUE_ASSIGNED
  ISSUE_RESOLVED
  ISSUE_MARK_DAMAGED
}

enum NR_STATUS {
  UNREAD
  READ
  DISMISSED
}

enum NR_EVENT {
  APPROVAL_REQUESTED
  REQUEST_FULFILLED
  REQUEST_RESOLVED
  YOUR_TICKET_APPROVED
  YOUR_TICKET_STAGE_APPROVED
  YOUR_TICKET_REJECTED
  YOUR_TICKET_IN_USE
  YOUR_TICKET_RETURNED
  DUE_SOON_REMINDER
  OVERDUE_ALERT
  ISSUE_NEW_FOR_TECH
  ISSUE_ASSIGNED_TO_YOU
  ISSUE_RESOLVED_FOR_REPORTER
}

enum CM_ROLE {
  user
  assistant
  system
  tool
  admin
}

enum CM_STATUS {
  ok
  error
  blocked
}

enum LDC_ACTION {
  BORROWED
  RETURNED
  CHANGED
  RESOLVED
  MARK_DAMAGED
}

enum LBR_ACTION {
  CREATED
  UPDATED
  APPROVED
  REJECTED
  RETURNED
  MARK_DAMAGED
  MARK_LOST
}

enum LI_ACTION {
  REPORTED
  ASSIGNED
  UPDATED
  RESOLVED
  MARK_DAMAGED
  CANCELLED
}

// ---------- Models ----------
model departments {
  dept_id    Int       @id @default(autoincrement())
  dept_name  String    @unique @db.VarChar(200)
  deleted_at DateTime? @db.Timestamptz(6)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @updatedAt @db.Timestamptz(6)

  sections                 sections[]
  users                    users[]
  approval_flow_steps      approval_flow_steps[]
  borrowReturnTicketStages borrow_return_ticket_stages[]
}

// model approval_positions {
//   ap_id      Int       @id @default(autoincrement())
//   ap_name    String    @unique @db.VarChar(200)
//   deleted_at DateTime? @db.Timestamptz(6)
//   created_at DateTime? @db.Timestamptz(6)
//   updated_at DateTime? @db.Timestamptz(6)

//   users                users[]
//   approval_flow_steps  approval_flow_steps[]
//   borrow_return_stages borrow_return_ticket_stages[]
// }

model sections {
  sec_id      Int       @id @default(autoincrement())
  sec_name    String    @unique @db.VarChar(50)
  sec_dept_id Int
  deleted_at  DateTime? @db.Timestamptz(6)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @updatedAt @db.Timestamptz(6)

  department departments @relation(fields: [sec_dept_id], references: [dept_id], onDelete: Cascade)
  users      users[]
  devices    devices[]

  approval_flow_steps      approval_flow_steps[]
  borrowReturnTicketStages borrow_return_ticket_stages[]

  @@index([sec_dept_id], map: "idx_sections_dept")
}

model users {
  us_id        Int       @id @default(autoincrement())
  us_emp_code  String?   @unique @db.VarChar(100)
  us_firstname String    @db.VarChar(150)
  us_lastname  String    @db.VarChar(150)
  us_username  String    @unique @db.VarChar(150)
  us_password  String    @db.VarChar(255)
  us_email     String    @unique @db.VarChar(150)
  us_phone     String    @db.VarChar(20)
  us_role      US_ROLE
  us_images    String?   @db.VarChar(200)
  // us_pa_id     Int?
  us_dept_id   Int?
  us_sec_id    Int?
  us_is_active Boolean   @default(true)
  deleted_at   DateTime? @db.Timestamptz(6)
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  updated_at   DateTime? @updatedAt @db.Timestamptz(6)

  // approval_position approval_positions? @relation(fields: [us_pa_id], references: [ap_id])
  department departments? @relation(fields: [us_dept_id], references: [dept_id], onDelete: SetNull)
  section    sections?    @relation(fields: [us_sec_id], references: [sec_id], onDelete: SetNull)

  // Relations (backrefs)
  devices_added        devices[]                     @relation("devices_added_by")
  approval_flows       approval_flows[]              @relation("approval_flow_creator")
  brt_requested        borrow_return_tickets[]       @relation("brt_requester")
  brt_staffed          borrow_return_tickets[]       @relation("brt_staff")
  brt_stages_approved  borrow_return_ticket_stages[] @relation("brts_approver")
  issues_reported      ticket_issues[]               @relation("ti_reporter")
  issues_assigned      ticket_issues[]               @relation("ti_assignee")
  issue_attachments    issue_attachments[]
  notification_targets notification_recipients[]
  logs_borrow_returns  log_borrow_returns[]          @relation("lbr_actor")
  logs_issues          log_issues[]                  @relation("li_actor")
  chat_rooms           chat_rooms[]
  carts                carts[]
  refresh_tokens       refresh_tokens[]
  logDeviceChilds      log_device_childs[]

  // @@index([us_pa_id], map: "idx_users_position")
  @@index([us_dept_id, us_sec_id], map: "idx_users_dept_sec")
  @@index([us_is_active], map: "idx_users_active")
}

model devices {
  de_id              Int       @id @default(autoincrement())
  de_serial_number   String    @unique @db.VarChar(100)
  de_name            String    @db.VarChar(200)
  de_description     String?   @db.VarChar(250)
  de_location        String    @db.VarChar(200)
  de_max_borrow_days Int
  de_images          String?   @db.VarChar(200)
  de_af_id           Int
  de_ca_id           Int
  de_us_id           Int
  de_sec_id          Int
  deleted_at         DateTime? @db.Timestamptz(6)
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
  updated_at         DateTime? @updatedAt @db.Timestamptz(6)

  approval_flow approval_flows @relation(fields: [de_af_id], references: [af_id])
  category      categories     @relation(fields: [de_ca_id], references: [ca_id])
  added_by      users          @relation("devices_added_by", fields: [de_us_id], references: [us_id])
  section       sections?      @relation(fields: [de_sec_id], references: [sec_id], onDelete: SetNull)

  accessories   accessories[]
  device_childs device_childs[]
  cart_items    cart_items[]
  ticket_issues ticket_issues[]

  @@index([de_ca_id], map: "idx_devices_category")
}

model device_childs {
  dec_id                Int                 @id @default(autoincrement())
  dec_serial_number     String?             @unique @db.VarChar(250)
  dec_asset_code        String              @unique @db.VarChar(200)
  dec_has_serial_number Boolean             @default(false)
  dec_status            DEVICE_CHILD_STATUS
  dec_de_id             Int
  deleted_at            DateTime?           @db.Timestamptz(6)
  created_at            DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at            DateTime?           @updatedAt @db.Timestamptz(6)

  device devices @relation(fields: [dec_de_id], references: [de_id])

  ticket_devices     ticket_devices[]
  availabilities     device_availabilities[]
  cart_device_childs cart_device_childs[]
  logDeviceChilds    log_device_childs[]

  @@index([dec_de_id], map: "idx_child_device")
  @@index([dec_status], map: "idx_child_status")
}

model carts {
  ct_id       Int       @id @default(autoincrement())
  ct_quantity Int       @default(1)
  ct_us_id    Int
  deleted_at  DateTime? @db.Timestamptz(6)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @updatedAt @db.Timestamptz(6)

  owner      users        @relation(fields: [ct_us_id], references: [us_id])
  cart_items cart_items[]

  @@index([ct_us_id], map: "idx_cart_user_status")
}

model cart_items {
  cti_id             Int       @id @default(autoincrement())
  cti_us_name        String?   @db.VarChar(255)
  cti_phone          String?   @db.VarChar(20)
  cti_note           String?   @db.VarChar(255)
  cti_usage_location String?   @db.VarChar(255)
  cti_quantity       Int       @default(1)
  cti_start_date     DateTime? @db.Timestamptz(6)
  cti_end_date       DateTime? @db.Timestamptz(6)
  cti_ct_id          Int
  cti_de_id          Int
  deleted_at         DateTime? @db.Timestamptz(6)
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
  updated_at         DateTime? @updatedAt @db.Timestamptz(6)

  cart               carts                @relation(fields: [cti_ct_id], references: [ct_id])
  device             devices              @relation(fields: [cti_de_id], references: [de_id])
  cart_device_childs cart_device_childs[]

  @@unique([cti_ct_id, cti_de_id], map: "uq_ct_item_device")
  @@index([cti_ct_id], map: "idx_ct_item_cart")
  @@index([cti_de_id], map: "idx_ct_item_device")
}

model cart_device_childs {
  cdc_id      Int       @id @default(autoincrement())
  cdc_cti_id  Int
  cdc_dec_id  Int
  deleted_at  DateTime? @db.Timestamptz(6)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @updatedAt @db.Timestamptz(6)
  reserved_at DateTime? @default(now()) @db.Timestamptz(6)

  cart_item    cart_items    @relation(fields: [cdc_cti_id], references: [cti_id])
  device_child device_childs @relation(fields: [cdc_dec_id], references: [dec_id])
}

model refresh_tokens {
  rt_id         Int       @id @default(autoincrement())
  rt_us_id      Int
  rt_token_hash String    @unique @db.VarChar(255)
  rt_revoked_at DateTime? @db.Timestamptz(6)
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  updated_at    DateTime? @updatedAt @db.Timestamptz(6)

  user users @relation(fields: [rt_us_id], references: [us_id])

  @@index([rt_us_id], map: "idx_rt_user_exp")
  @@index([rt_revoked_at], map: "idx_rt_revoked")
}

model accessories {
  acc_id       Int       @id @default(autoincrement())
  acc_name     String    @db.VarChar(100)
  acc_quantity Int
  acc_de_id    Int?
  deleted_at   DateTime? @db.Timestamptz(6)
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  updated_at   DateTime? @updatedAt @db.Timestamptz(6)

  device devices? @relation(fields: [acc_de_id], references: [de_id], onDelete: Cascade)

  @@index([acc_de_id])
}

model categories {
  ca_id      Int       @id @default(autoincrement())
  ca_name    String    @db.VarChar(100)
  deleted_at DateTime? @db.Timestamptz(6)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @updatedAt @db.Timestamptz(6)

  devices devices[]
}

model approval_flows {
  af_id        Int       @id @default(autoincrement())
  af_name      String    @db.VarChar(100)
  af_is_active Boolean   @default(true)
  af_us_id     Int
  deleted_at   DateTime? @db.Timestamptz(6)
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  updated_at   DateTime? @updatedAt @db.Timestamptz(6)

  creator users @relation("approval_flow_creator", fields: [af_us_id], references: [us_id])

  steps   approval_flow_steps[]
  devices devices[]
  tickets borrow_return_tickets[]
}

model approval_flow_steps {
  afs_id           Int       @id @default(autoincrement())
  afs_step_approve Int
  // afs_pa_id        Int
  afs_dept_id      Int?
  afs_sec_id       Int?
  afs_role         US_ROLE
  afs_af_id        Int
  deleted_at       DateTime? @db.Timestamptz(6)
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  updated_at       DateTime? @updatedAt @db.Timestamptz(6)

  // position approval_positions @relation(fields: [afs_pa_id], references: [ap_id])
  flow       approval_flows @relation(fields: [afs_af_id], references: [af_id])
  department departments?   @relation(fields: [afs_dept_id], references: [dept_id])
  section    sections?      @relation(fields: [afs_sec_id], references: [sec_id])

  // @@index([afs_af_id, afs_pa_id, afs_step_approve], map: "idx_steps_flow_step")
  @@index([afs_af_id, afs_step_approve], map: "idx_steps_flow_step")
}

model device_availabilities {
  da_id      Int       @id @default(autoincrement())
  da_dec_id  Int
  da_brt_id  Int
  da_start   DateTime  @db.Timestamptz(6)
  da_end     DateTime  @db.Timestamptz(6)
  da_status  DA_STATUS @default(ACTIVE)
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @updatedAt @db.Timestamptz(6)

  device_child device_childs         @relation(fields: [da_dec_id], references: [dec_id])
  ticket       borrow_return_tickets @relation(fields: [da_brt_id], references: [brt_id])

  @@index([da_dec_id, da_start, da_end], map: "idx_avail_device_period")
  @@index([da_status], map: "idx_avail_status")
}

model borrow_return_tickets {
  brt_id              Int        @id @default(autoincrement())
  brt_status          BRT_STATUS
  brt_usage_location  String     @db.VarChar(255)
  brt_borrow_purpose  String     @db.VarChar(255)
  brt_start_date      DateTime   @db.Timestamptz(6)
  brt_end_date        DateTime   @db.Timestamptz(6)
  brt_quantity        Int        @default(1)
  brt_current_stage   Int?
  brt_reject_reason   String?    @db.VarChar(255)
  brt_pickup_location String?    @db.VarChar(255)
  brt_pickup_datetime DateTime?  @db.Timestamptz(6)
  brt_return_location String?    @db.VarChar(255)
  brt_return_datetime DateTime?  @db.Timestamptz(6)
  brt_af_id           Int?
  brt_user_id         Int
  brt_staff_id        Int?
  deleted_at          DateTime?  @db.Timestamptz(6)
  created_at          DateTime?  @default(now()) @db.Timestamptz(6)
  updated_at          DateTime?  @updatedAt @db.Timestamptz(6)

  flow      approval_flows? @relation(fields: [brt_af_id], references: [af_id])
  requester users           @relation("brt_requester", fields: [brt_user_id], references: [us_id])
  staffer   users?          @relation("brt_staff", fields: [brt_staff_id], references: [us_id])

  stages          borrow_return_ticket_stages[]
  ticket_devices  ticket_devices[]
  notifications   notifications[]
  logs_borrow     log_borrow_returns[]
  ticket_issues   ticket_issues[]
  availabilities  device_availabilities[]
  logDeviceChilds log_device_childs[]

  @@index([brt_user_id, brt_staff_id, brt_status, created_at], map: "idx_brt_user_status_created")
  @@index([brt_af_id], map: "idx_brt_flow")
  @@index([brt_start_date, brt_end_date], map: "idx_brt_start_end")
}

model borrow_return_ticket_stages {
  brts_id           Int         @id @default(autoincrement())
  brts_status       BRTS_STATUS
  brts_name         String      @db.VarChar(191)
  brts_step_approve Int

  brts_role    US_ROLE
  brts_dept_id Int?
  brts_sec_id  Int?

  brts_dept_name String? @db.VarChar(200)
  brts_sec_name  String? @db.VarChar(200)

  brts_brt_id Int
  // brts_pa_id        Int
  brts_us_id  Int?
  deleted_at  DateTime? @db.Timestamptz(6)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @updatedAt @db.Timestamptz(6)

  ticket   borrow_return_tickets @relation(fields: [brts_brt_id], references: [brt_id])
  // position approval_positions    @relation(fields: [brts_pa_id], references: [ap_id])
  approver users?                @relation("brts_approver", fields: [brts_us_id], references: [us_id])

  department departments? @relation(fields: [brts_dept_id], references: [dept_id], onDelete: SetNull)
  section    sections?    @relation(fields: [brts_sec_id], references: [sec_id], onDelete: SetNull)

  notifications notifications[]

  @@index([brts_id, brts_step_approve], map: "idx_brts_brt_step")
  @@index([brts_status], map: "idx_brts_status")
  @@index([brts_status, brts_role, brts_dept_id, brts_sec_id], map: "idx_brts_pending_lookup")
}

model ticket_devices {
  td_id            Int       @id @default(autoincrement())
  td_brt_id        Int
  td_dec_id        Int
  td_origin_cti_id Int?
  deleted_at       DateTime? @db.Timestamptz(6)
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  updated_at       DateTime? @updatedAt @db.Timestamptz(6)

  ticket borrow_return_tickets @relation(fields: [td_brt_id], references: [brt_id])
  child  device_childs         @relation(fields: [td_dec_id], references: [dec_id])

  @@unique([td_brt_id, td_dec_id], map: "uq_ticket_device")
  @@index([td_brt_id], map: "idx_ticket_device_brt")
  @@index([td_dec_id], map: "idx_ticket_device_child")
}

model ticket_issues {
  ti_id             Int       @id @default(autoincrement())
  ti_de_id          Int
  ti_brt_id         Int?
  ti_title          String    @db.VarChar(200)
  ti_description    String
  ti_reported_by    Int
  ti_assigned_to    Int?
  ti_status         TI_STATUS
  ti_result         TI_RESULT
  ti_damaged_reason String?   @db.VarChar(255)
  ti_resolved_note  String?
  receive_at        DateTime? @db.Timestamptz(6)
  success_at        DateTime? @db.Timestamptz(6)
  deleted_at        DateTime? @db.Timestamptz(6)
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @updatedAt @db.Timestamptz(6)

  device   devices                @relation(fields: [ti_de_id], references: [de_id])
  ticket   borrow_return_tickets? @relation(fields: [ti_brt_id], references: [brt_id])
  reporter users                  @relation("ti_reporter", fields: [ti_reported_by], references: [us_id])
  assignee users?                 @relation("ti_assignee", fields: [ti_assigned_to], references: [us_id])

  attachments     issue_attachments[]
  notifications   notifications[]
  logs            log_issues[]
  logDeviceChilds log_device_childs[]

  @@index([ti_de_id, ti_status, created_at], map: "idx_issue_device_status")
  @@index([ti_assigned_to, ti_status], map: "idx_issue_assignee")
}

model issue_attachments {
  iatt_id       Int       @id @default(autoincrement())
  iatt_path_url String    @db.VarChar(255)
  iatt_ti_id    Int
  uploaded_by   Int
  deleted_at    DateTime? @db.Timestamptz(6)
  uploaded_at   DateTime  @default(now()) @db.Timestamptz(6)

  issue ticket_issues @relation(fields: [iatt_ti_id], references: [ti_id])
  user  users         @relation(fields: [uploaded_by], references: [us_id])

  @@index([iatt_ti_id], map: "idx_issue_attachments_issue")
}

model notifications {
  n_id           Int         @id @default(autoincrement())
  n_title        String      @db.VarChar(200)
  n_message      String
  n_data         Json?       @db.JsonB
  n_target_route String?     @db.VarChar(255)
  n_base_event   BASE_EVENT?
  n_brt_id       Int?
  n_brts_id      Int?
  n_ti_id        Int?
  created_at     DateTime    @default(now()) @db.Timestamptz(6)
  send_at        DateTime?   @default(now()) @db.Timestamptz(6)

  brt  borrow_return_tickets?       @relation(fields: [n_brt_id], references: [brt_id])
  brts borrow_return_ticket_stages? @relation(fields: [n_brts_id], references: [brts_id])
  ti   ticket_issues?               @relation(fields: [n_ti_id], references: [ti_id])

  recipients notification_recipients[]

  @@index([created_at], map: "idx_notif_created")
  @@index([n_brt_id], map: "idx_notif_brt")
  @@index([n_brts_id], map: "idx_notif_brts")
  @@index([n_ti_id], map: "idx_notif_issue")
}

model notification_recipients {
  nr_id        Int       @id @default(autoincrement())
  nr_status    NR_STATUS
  nr_event     NR_EVENT
  nr_n_id      Int
  nr_us_id     Int
  read_at      DateTime? @db.Timestamptz(6)
  dismissed_at DateTime? @db.Timestamptz(6)

  notification notifications @relation(fields: [nr_n_id], references: [n_id])
  user         users         @relation(fields: [nr_us_id], references: [us_id])

  @@index([nr_us_id, nr_status, nr_n_id], map: "idx_notifrec_user_status")
}

model log_borrow_returns {
  lbr_id         Int        @id @default(autoincrement())
  lbr_action     LBR_ACTION // enum in DBML; store as text or create enum if needed
  lbr_old_status String?    @db.VarChar(50)
  lbr_new_status String?    @db.VarChar(50)
  lbr_note       String?
  lbr_actor_id   Int?
  lbr_brt_id     Int
  created_at     DateTime   @default(now()) @db.Timestamptz(6)

  brt   borrow_return_tickets @relation(fields: [lbr_brt_id], references: [brt_id])
  actor users?                @relation("lbr_actor", fields: [lbr_actor_id], references: [us_id])

  @@index([lbr_brt_id, created_at], map: "idx_log_brt")
}

model log_issues {
  li_id         Int       @id @default(autoincrement())
  li_action     LI_ACTION // enum in DBML; store as text or create enum if needed
  li_old_status String?   @db.VarChar(50)
  li_new_status String?   @db.VarChar(50)
  li_note       String?
  li_actor_id   Int?
  li_ti_id      Int
  created_at    DateTime  @default(now()) @db.Timestamptz(6)

  issue ticket_issues @relation(fields: [li_ti_id], references: [ti_id])
  actor users?        @relation("li_actor", fields: [li_actor_id], references: [us_id])

  @@index([li_ti_id, created_at], map: "idx_log_issue")
}

model log_device_childs {
  ldc_id         Int        @id @default(autoincrement())
  ldc_action     LDC_ACTION // ใช้ Enum ที่เพิ่งสร้าง
  ldc_old_status String?    @db.VarChar(50)
  ldc_new_status String?    @db.VarChar(50)
  ldc_note       String?
  ldc_actor_id   Int?
  ldc_ti_id      Int?
  ldc_brt_id     Int?
  ldc_dec_id     Int?
  created_at     DateTime   @default(now()) @db.Timestamptz(6)

  // Relations
  actor        users?                 @relation(fields: [ldc_actor_id], references: [us_id])
  ticket_issue ticket_issues?         @relation(fields: [ldc_ti_id], references: [ti_id])
  ticket_brt   borrow_return_tickets? @relation(fields: [ldc_brt_id], references: [brt_id])
  device_child device_childs?         @relation(fields: [ldc_dec_id], references: [dec_id])

  // @@index([ldc_ti_id, created_at], map: "idx_log_issue") // หมายเหตุ: "idx_log_issue" ซ้ำกับใน model log_issues
  @@index([ldc_ti_id, created_at], map: "idx_ldc_log_issue") // แนะนำให้เปลี่ยนชื่อ map
  @@index([ldc_dec_id, created_at], map: "idx_log_device_history")
}

model chat_rooms {
  cr_id       Int       @id @default(autoincrement())
  cr_us_id    Int
  cr_title    String?   @db.VarChar(200)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @updatedAt @db.Timestamptz(6)
  last_msg_at DateTime? @db.Timestamptz(6)

  owner    users           @relation(fields: [cr_us_id], references: [us_id])
  messages chat_messages[]

  @@index([cr_us_id, last_msg_at])
  @@index([last_msg_at])
}

model chat_messages {
  cm_id           Int       @id @default(autoincrement())
  cm_role         CM_ROLE
  cm_content      String
  cm_content_json Json?
  cm_status       CM_STATUS @default(ok)
  cm_parent_id    Int?
  cm_cr_id        Int
  created_at      DateTime  @default(now()) @db.Timestamptz(6)

  room        chat_rooms         @relation(fields: [cm_cr_id], references: [cr_id], onDelete: Cascade)
  parent      chat_messages?     @relation("cm_parent", fields: [cm_parent_id], references: [cm_id])
  replies     chat_messages[]    @relation("cm_parent")
  attachments chat_attachments[]

  @@index([cm_cr_id, created_at])
  @@index([cm_role])
}

model chat_attachments {
  catt_id        Int      @id @default(autoincrement())
  catt_cm_id     Int
  catt_file_path String   @db.VarChar(500)
  created_at     DateTime @default(now()) @db.Timestamptz(6)

  message chat_messages @relation(fields: [catt_cm_id], references: [cm_id], onDelete: Cascade)

  @@index([catt_cm_id])
}